<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Décodeur de quiz</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }
    .question-block {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 1rem;
    }
    input[type="text"] {
      width: 150px;
    }
    select {
      margin-left: 1rem;
    }
  </style>
</head>
<body>
  <h1>Décodeur de quiz</h1>

  <p>
    Entrez un code (base 36) et choisissez un fichier JSON depuis le dossier du site.
  </p>

  <div>
    <input type="text" id="decodeInput" placeholder="e.g. A8" />
    <button id="decodeBtn">Décoder</button>

    <label for="jsonSelect">Choisir un fichier :</label>
    <select id="jsonSelect">
      <option value="">-- Choisir --</option>
      <option value="ivan.json">ivan</option>
      <option value="eol.json">eol</option>
      <option value="maximilien.json">maximilien</option>
      <option value="melisandre.json">melisandre</option>
      <option value="nahis.json">nahis</option>
    </select>
  </div>

  <div id="decodedResult"></div>

  <script>
    let quizData = [];

    // Load JSON from same folder
    document.getElementById("jsonSelect").addEventListener("change", async (e) => {
      const file = e.target.value;
      if (!file) return;

      try {
        const response = await fetch(file);
        if (!response.ok) throw new Error("Échec du chargement");

        quizData = await response.json();
        alert("Fichier chargé : " + file);
      } catch (err) {
        alert("Erreur lors du chargement du fichier JSON.");
        quizData = [];
      }
    });

    function decodeAnswersBase4(code, maxLength = 100) {
      let number = parseInt(code, 36);
      const answers = [];
      while (number > 0 && answers.length < maxLength) {
        answers.unshift((number % 4) + 1);
        number = Math.floor(number / 4);
      }
      return answers;
    }

    document.getElementById("decodeBtn").addEventListener("click", () => {
      const code = document.getElementById("decodeInput").value.trim().toUpperCase();
      const resultEl = document.getElementById("decodedResult");
      if (!/^[0-9A-Z]+$/.test(code)) {
        resultEl.textContent = "Code invalide.";
        return;
      }

      if (!quizData.length) {
        resultEl.textContent = "Veuillez d'abord choisir un fichier JSON.";
        return;
      }

      const decodedAnswers = decodeAnswersBase4(code, 100);
      const log = [];
      let answerIndex = 0;
      let currentId = quizData[0].id;

      while (currentId && answerIndex < decodedAnswers.length) {
        const question = quizData.find(q => q.id === currentId);
        if (!question) break;

        const selected = decodedAnswers[answerIndex] || 1;
        const choiceText = question.choices[selected - 1] || "Réponse inconnue";

        log.push({
          id: question.id,
          question: question.question,
          selected: selected,
          answer: choiceText
        });

        const next = question.next;
        if (!next) break;
        const nextId = next[selected.toString()] || next["any"];
        currentId = nextId;
        answerIndex++;
      }

      resultEl.innerHTML = `<p><strong>Réponses décodées:</strong> [${decodedAnswers.join(", ")}]</p>`;
      resultEl.innerHTML += `<h3>Chemin parcouru :</h3>`;
      log.forEach((entry, i) => {
        resultEl.innerHTML += `
          <div class="question-block">
            <strong>Q${i + 1} [${entry.id}]</strong><br/>
            ${entry.question}<br/>
            ➤ <em>${entry.answer}</em>
          </div>
        `;
      });
    });
  </script>
</body>
</html>
